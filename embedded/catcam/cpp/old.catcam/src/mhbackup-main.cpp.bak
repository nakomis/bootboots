// ESP32-CAM I2C Scanner and PCF8574 Test Program
#include <Arduino.h>
#include <Wire.h>

// Pins
#define I2C_SDA 1  // GPIO1 (U0TXD) - SDA
#define I2C_SCL 3  // GPIO3 (U0RXD) - SCL
#define LED_PIN 33  // Built-in red LED

// PCF8574 I2C Address (0x20-0x27 depending on A0-A2 jumpers)
#define PCF8574_ADDRESS 0x20

// Function declarations
void scanI2C();
void testPCF8574();

#define BUTTON_PIN 0  // GPIO0 (BOOT button)

void setup() {
  // Disable watchdog timers that might cause resets
  disableCore0WDT();
  disableCore1WDT();
  
  // Initialize LED
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, HIGH);  // Turn OFF (active LOW)
  
  // Initialize button pin
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  
  // Flash LED to indicate waiting for button press
  while(digitalRead(BUTTON_PIN) == HIGH) {
    digitalWrite(LED_PIN, LOW);
    delay(200);
    digitalWrite(LED_PIN, HIGH);
    delay(200);
  }
  
  // Button pressed, wait for release
  while(digitalRead(BUTTON_PIN) == LOW) {
    delay(10);
  }
  
  // Indicate button was pressed
  for(int i = 0; i < 3; i++) {
    digitalWrite(LED_PIN, LOW);
    delay(100);
    digitalWrite(LED_PIN, HIGH);
    delay(100);
  }
  delay(1000);  // Give time to reconnect PCF8574
  
  // Long blink to show program start
  digitalWrite(LED_PIN, LOW);
  delay(1000);
  digitalWrite(LED_PIN, HIGH);
  delay(1000);
  
  // Double blink to show setup is running
  for(int i = 0; i < 2; i++) {
    digitalWrite(LED_PIN, LOW);
    delay(200);
    digitalWrite(LED_PIN, HIGH);
    delay(200);
  }
  
  // Long blink to show I2C init starting
  digitalWrite(LED_PIN, LOW);
  delay(1000);  // 1 second ON
  digitalWrite(LED_PIN, HIGH);
  delay(1000);  // 1 second OFF
  
  // Initialize I2C with custom pins
  Wire.begin(I2C_SDA, I2C_SCL);
  Wire.setClock(100000);  // 100kHz I2C clock
  
  // Double blink to show I2C initialized
  for(int i = 0; i < 2; i++) {
    digitalWrite(LED_PIN, LOW);
    delay(200);
    digitalWrite(LED_PIN, HIGH);
    delay(200);
  }
  
  // Wait a moment for serial to initialize
  delay(1000);
  
  // Scan I2C bus
  scanI2C();
  
  // Wait before testing PCF8574
  delay(2000);
  
  // Test PCF8574 if button is pressed during startup (optional)
  // Uncomment the next line if you want to test PCF8574 only when a button is pressed
  // if (digitalRead(0) == LOW) {  // Assuming a button is connected to GPIO0 and GND
    testPCF8574();
  // }
}

void loop() {
  // Slow blink to show program is running
  digitalWrite(LED_PIN, LOW);
  delay(1000);
  digitalWrite(LED_PIN, HIGH);
  delay(1000);
  
  // Reset the watchdog timer
  yield();
}

void scanI2C() {
  byte error, address;
  int nDevices = 0;
  
  // Blink LED for each device found
  for(address = 1; address < 127; address++) {
    Wire.beginTransmission(address);
    error = Wire.endTransmission();
    
    if (error == 0) {
      nDevices++;
      // Blink for device found (3 quick blinks for each device)
      for(int i = 0; i < 3; i++) {
        digitalWrite(LED_PIN, LOW);
        delay(100);
        digitalWrite(LED_PIN, HIGH);
        delay(100);
      }
      delay(500); // Pause between devices
    }
  }
  
  // If no devices found, do a long blink
  if (nDevices == 0) {
    digitalWrite(LED_PIN, LOW);
    delay(1000);
    digitalWrite(LED_PIN, HIGH);
  }
}

void testPCF8574() {
  // Try to write to PCF8574
  Wire.beginTransmission(PCF8574_ADDRESS);
  Wire.write(0x00);  // Try to write all outputs LOW
  byte error = Wire.endTransmission();
  
  if (error == 0) {
    // Success - blink LED quickly 5 times
    for(int i = 0; i < 5; i++) {
      digitalWrite(LED_PIN, LOW);
      delay(100);
      digitalWrite(LED_PIN, HIGH);
      delay(100);
    }
  } else {
    // Failure - long blink
    for(int i = 0; i < 3; i++) {
      digitalWrite(LED_PIN, LOW);
      delay(500);
      digitalWrite(LED_PIN, HIGH);
      delay(500);
    }
  }
}
